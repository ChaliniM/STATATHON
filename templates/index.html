<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Clean & Find - AI Data Tool</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body class="bg-light">

<div class="container py-4">
    <h1 class="text-center mb-4 text-primary fw-bold">Clean & Find</h1>
    <h5 class="text-center text-muted mb-4">AI-Powered Data Cleaning & Semantic Search</h5>

    {% if not uploaded %}
        <div class="card shadow p-4">
            <form method="POST" enctype="multipart/form-data">
                <div class="mb-3">
                    <label class="form-label">Upload Dataset (CSV/Excel)</label>
                    <input type="file" class="form-control" name="file" required>
                </div>
                <div class="mb-3">
                    <label class="form-label">Search Column (Exact Name)</label>
                    <input type="text" class="form-control" name="search_column" placeholder="e.g., Occupation" required>
                </div>
                <button type="submit" class="btn btn-primary w-100">Upload & Clean</button>
            </form>
        </div>
    {% else %}
        <div class="mb-4">
            <h4 class="fw-bold">Cleaning Report</h4>
            <table class="table table-bordered">
                <thead>
                    <tr>
                        <th>Stage</th>
                        <th>Rows x Columns</th>
                        <th>Missing Values</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td>Before Cleaning</td>
                        <td>{{ report.initial_shape }}</td>
                        <td>{{ report.missing_values_before }}</td>
                    </tr>
                    <tr>
                        <td>After Cleaning</td>
                        <td>{{ report.final_shape }}</td>
                        <td>{{ report.missing_values_after }}</td>
                    </tr>
                </tbody>
            </table>
        </div>

        <!-- Missing Values Chart -->
        <div class="mb-4">
            <canvas id="missingChart"></canvas>
        </div>

        <a href="/download" class="btn btn-success mb-4">Download Cleaned Dataset</a>

        <div class="card p-4 shadow">
            <h4 class="fw-bold">Semantic Search</h4>
            <form id="searchForm" class="mb-3">
                <input type="text" class="form-control mb-2" name="query" placeholder="Search term..." required>
                <button type="submit" class="btn btn-primary">Search</button>
            </form>
            <ul id="results" class="list-group"></ul>
        </div>

        <script>
            // Chart.js with error handling
            try {
                const before = Object.values(JSON.parse('{{ report_before|safe }}'));
                const after = Object.values(JSON.parse('{{ report_after|safe }}'));
                const labels = Object.keys(JSON.parse('{{ report_before|safe }}'));

                new Chart(document.getElementById('missingChart'), {
                    type: 'bar',
                    data: {
                        labels: labels,
                        datasets: [
                            {
                                label: 'Before Cleaning',
                                data: before,
                                backgroundColor: 'rgba(255, 99, 132, 0.7)'
                            },
                            {
                                label: 'After Cleaning',
                                data: after,
                                backgroundColor: 'rgba(54, 162, 235, 0.7)'
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        plugins: { legend: { position: 'top' } }
                    }
                });
            } catch (err) {
                console.error("Chart rendering error:", err);
            }

            // Semantic Search
            document.getElementById("searchForm").onsubmit = async function(e) {
                e.preventDefault();
                let formData = new FormData(this);
                let res = await fetch("/search", { method: "POST", body: formData });
                let data = await res.json();
                let list = document.getElementById("results");
                list.innerHTML = "";
                if (data.results && data.results.length > 0) {
                    data.results.forEach(r => {
                        let li = document.createElement("li");
                        li.textContent = r;
                        li.className = "list-group-item";
                        list.appendChild(li);
                    });
                } else {
                    let li = document.createElement("li");
                    li.textContent = "No matches found.";
                    li.className = "list-group-item text-muted";
                    list.appendChild(li);
                }
            }
        </script>
    {% endif %}
</div>

</body>
</html>
